2025-09-22 22:28:53 - root - INFO - [logging_config.py:51] - Logging configurado. Arquivo: C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\logs\cadvision_20250922_222849.log
2025-09-22 22:28:53 - app - INFO - [logging_config.py:68] - EVENT: startup - DATA: {'timestamp': '2025-09-22T22:28:53.579633', 'service': 'app', 'event': 'startup', 'data': {'version': '1.1.0'}}
2025-09-22 22:28:53 - app.database - INFO - [database.py:175] - Banco de dados inicializado com sucesso (com novo schema).
2025-09-22 22:28:53 - app - INFO - [logging_config.py:68] - EVENT: database_initialized - DATA: {'timestamp': '2025-09-22T22:28:53.582634', 'service': 'app', 'event': 'database_initialized', 'data': {}}
2025-09-22 22:29:09 - vision/identify - INFO - [logging_config.py:68] - EVENT: process_started - DATA: {'timestamp': '2025-09-22T22:29:09.469801', 'service': 'vision/identify', 'event': 'process_started', 'data': {'vertical': 'vestuario', 'tag_image': 'Imagem do WhatsApp de 2025-09-21 à(s) 16.46.16_17ae13c9.jpg', 'product_image': 'Imagem do WhatsApp de 2025-09-22 à(s) 18.59.39_a2b1167e.jpg'}}
2025-09-22 22:29:09 - vision/identify - INFO - [logging_config.py:68] - EVENT: text_extraction_start - DATA: {'timestamp': '2025-09-22T22:29:09.470801', 'service': 'vision/identify', 'event': 'text_extraction_start', 'data': {'hash': 'b2fc004d6c9b4e068ae9234462176855'}}
2025-09-22 22:29:09 - app.services.vision_service - INFO - [vision_service.py:109] - Imagem aprimorada para OCR.
2025-09-22 22:29:12 - app.services.vision_service - INFO - [vision_service.py:182] - Vision API: Texto extraído (156 chars), Logos: 0, Labels: 0
2025-09-22 22:29:12 - app.services.vision_service - INFO - [vision_service.py:277] - Texto bruto: '100% ALGODÃO
DECOTE: 98% ALGODÃO
2% ELASTANO
FORNECEDOR: 84891
Modelo: 1059827 - T. 20
40
P W
P
日
Cor VERDE CLARO
000000113667090314
SKU: 11366709
PO:288843' -> Texto limpo para análise: '100982848911059827204000000011366709031411366709288843'
2025-09-22 22:29:12 - app.services.vision_service - WARNING - [vision_service.py:298] - Nenhum GTIN válido encontrado no texto limpo: '100982848911059827204000000011366709031411366709288843'
2025-09-22 22:29:12 - vision/identify - INFO - [logging_config.py:68] - EVENT: intelligent_analysis_start - DATA: {'timestamp': '2025-09-22T22:29:12.546117', 'service': 'vision/identify', 'event': 'intelligent_analysis_start', 'data': {'vertical': 'vestuario'}}
2025-09-22 22:29:12 - app.services.product_service - INFO - [product_service.py:89] - Iniciando Etapa 1 (Vertex AI Vector Search).
2025-09-22 22:29:12 - app.services.vector_search_service - ERROR - [vector_search_service.py:62] - Erro ao gerar o embedding da imagem: module 'google.cloud.aiplatform' has no attribute 'ImageModel'
2025-09-22 22:29:12 - app.services.product_service - INFO - [product_service.py:112] - Busca visual falhou ou não aplicável. Prosseguindo com a análise de texto/GTIN.
2025-09-22 22:29:12 - app.services.product_service - INFO - [product_service.py:126] - Via Rápida falhou ou não aplicável. Iniciando Etapa 3 (Inferência da IA).
2025-09-22 22:29:15 - ai_service - INFO - [logging_config.py:68] - EVENT: json_parsed_successfully - DATA: {'timestamp': '2025-09-22T22:29:15.792827', 'service': 'ai_service', 'event': 'json_parsed_successfully', 'data': {'title_extracted': 'Blusa Manga Longa Feminina', 'brand_extracted': None, 'category_extracted': 'Blusas'}}
2025-09-22 22:29:15 - app.services.product_service - INFO - [product_service.py:137] - Produto pré-identificado: Blusa Manga Longa Feminina
2025-09-22 22:29:15 - main - ERROR - [main.py:496] - Erro não tratado na rota http://127.0.0.1:8000/api/v1/vision/identify: 1 validation error for IdentifiedProduct
gtin
  Value error, GTIN deve ter 8, 12, 13 ou 14 dígitos [type=value_error, input_value='000000113667090314', input_type=str]
    For further information visit https://errors.pydantic.dev/2.11/v/value_error
Traceback (most recent call last):
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\middleware\gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\middleware\gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 148, in simple_response
    await self.app(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 65, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\routing.py", line 756, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\routing.py", line 776, in app
    await route.handle(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\routing.py", line 297, in handle
    await self.app(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\routing.py", line 77, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\starlette\routing.py", line 72, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\fastapi\routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\main.py", line 148, in identify_image
    identified_product = models.IdentifiedProduct(**product_info)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Pedro Diniz\Documents\CadVision\CadVision_app\backend\venv\Lib\site-packages\pydantic\main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IdentifiedProduct
gtin
  Value error, GTIN deve ter 8, 12, 13 ou 14 dígitos [type=value_error, input_value='000000113667090314', input_type=str]
    For further information visit https://errors.pydantic.dev/2.11/v/value_error
2025-09-22 22:32:02 - vision/identify - INFO - [logging_config.py:68] - EVENT: process_started - DATA: {'timestamp': '2025-09-22T22:32:02.904682', 'service': 'vision/identify', 'event': 'process_started', 'data': {'vertical': 'supermercado', 'tag_image': 'Imagem do WhatsApp de 2025-09-17 à(s) 18.48.26_20d1bdb5.jpg', 'product_image': None}}
2025-09-22 22:32:02 - vision/identify - INFO - [logging_config.py:68] - EVENT: text_extraction_start - DATA: {'timestamp': '2025-09-22T22:32:02.904682', 'service': 'vision/identify', 'event': 'text_extraction_start', 'data': {'hash': 'e909fe0f6cb4c1043e03c0e2d2763f0d'}}
2025-09-22 22:32:02 - app.services.vision_service - INFO - [vision_service.py:109] - Imagem aprimorada para OCR.
2025-09-22 22:32:05 - app.services.vision_service - INFO - [vision_service.py:182] - Vision API: Texto extraído (15 chars), Logos: 0, Labels: 5
2025-09-22 22:32:05 - app.services.vision_service - INFO - [vision_service.py:277] - Texto bruto: '7891340" 365576' -> Texto limpo para análise: '7891340365576'
2025-09-22 22:32:05 - app.services.vision_service - INFO - [vision_service.py:295] - GTIN validado com sucesso: 7891340365576
2025-09-22 22:32:05 - vision/identify - INFO - [logging_config.py:68] - EVENT: intelligent_analysis_start - DATA: {'timestamp': '2025-09-22T22:32:05.881420', 'service': 'vision/identify', 'event': 'intelligent_analysis_start', 'data': {'vertical': 'supermercado'}}
2025-09-22 22:32:05 - app.services.product_service - INFO - [product_service.py:112] - Busca visual falhou ou não aplicável. Prosseguindo com a análise de texto/GTIN.
2025-09-22 22:32:05 - app.services.product_service - INFO - [product_service.py:120] - Iniciando Etapa 2 (Via Rápida - GTIN) com GTIN: 7891340365576.
2025-09-22 22:32:07 - app.services.cosmos_service - INFO - [cosmos_service.py:72] - 📦 Dados formatados do Cosmos: {'gtin': '7891340365576', 'title': 'BISC LOOK WAFER 55G BRIGADEIRO', 'brand': '', 'category': 'Biscoito Wafer', 'ncm': '19053200', 'cest': '', 'confidence': 0.99, 'vertical': 'supermercado'}
2025-09-22 22:32:07 - app.services.product_service - INFO - [product_service.py:137] - Produto pré-identificado: BISC LOOK WAFER 55G BRIGADEIRO
2025-09-22 22:33:20 - vision/identify - INFO - [logging_config.py:68] - EVENT: process_started - DATA: {'timestamp': '2025-09-22T22:33:20.399160', 'service': 'vision/identify', 'event': 'process_started', 'data': {'vertical': 'supermercado', 'tag_image': 'Imagem do WhatsApp de 2025-09-18 à(s) 17.35.31_43df112f.jpg', 'product_image': None}}
2025-09-22 22:33:20 - vision/identify - INFO - [logging_config.py:68] - EVENT: text_extraction_start - DATA: {'timestamp': '2025-09-22T22:33:20.400160', 'service': 'vision/identify', 'event': 'text_extraction_start', 'data': {'hash': '9bb1516d4f8c2209c62d366630cfc6bb'}}
2025-09-22 22:33:20 - app.services.vision_service - INFO - [vision_service.py:109] - Imagem aprimorada para OCR.
2025-09-22 22:33:22 - app.services.vision_service - INFO - [vision_service.py:182] - Vision API: Texto extraído (87 chars), Logos: 0, Labels: 8
2025-09-22 22:33:22 - app.services.vision_service - INFO - [vision_service.py:277] - Texto bruto: '7 896022 200534
ИN
МИ
1
LOTE/VALIDADE/LOTE/VALIDEZ/BATCH/EXPIRY DATE:
145 $16
860202 V2' -> Texto limpo para análise: '78960222005341145168602022'
2025-09-22 22:33:22 - app.services.vision_service - INFO - [vision_service.py:295] - GTIN validado com sucesso: 7896022200534
2025-09-22 22:33:22 - vision/identify - INFO - [logging_config.py:68] - EVENT: intelligent_analysis_start - DATA: {'timestamp': '2025-09-22T22:33:22.664505', 'service': 'vision/identify', 'event': 'intelligent_analysis_start', 'data': {'vertical': 'supermercado'}}
2025-09-22 22:33:22 - app.services.product_service - INFO - [product_service.py:112] - Busca visual falhou ou não aplicável. Prosseguindo com a análise de texto/GTIN.
2025-09-22 22:33:22 - app.services.product_service - INFO - [product_service.py:120] - Iniciando Etapa 2 (Via Rápida - GTIN) com GTIN: 7896022200534.
2025-09-22 22:33:24 - app.services.cosmos_service - INFO - [cosmos_service.py:72] - 📦 Dados formatados do Cosmos: {'gtin': '7896022200534', 'title': 'MACARRÃO DE SÊMOLA PARAFUSO GALO PACOTE 500G', 'brand': 'SELMI', 'category': '', 'ncm': '19021900', 'cest': '', 'confidence': 0.99, 'vertical': 'supermercado'}
2025-09-22 22:33:24 - app.services.product_service - INFO - [product_service.py:137] - Produto pré-identificado: MACARRÃO DE SÊMOLA PARAFUSO GALO PACOTE 500G
2025-09-22 22:39:44 - app - INFO - [logging_config.py:68] - EVENT: shutdown - DATA: {'timestamp': '2025-09-22T22:39:44.916698', 'service': 'app', 'event': 'shutdown', 'data': {}}
2025-09-22 22:39:44 - main - INFO - [main.py:48] - Encerrando aplicação CadVision API.
